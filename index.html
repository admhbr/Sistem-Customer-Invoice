<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Invoice By Leo</title>
    <style>
        :root { --primary-blue: #004a99; --dark-grey: #444; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #525659; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .no-print-area { width: 29.7cm; background: #fff; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 10px; box-sizing: border-box; }
        .page { width: 29.7cm; height: 21cm; padding: 0.5cm 0.8cm; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); box-sizing: border-box; position: relative; display: flex; flex-direction: column; }

        h2 { color: var(--primary-blue); margin: 0; font-size: 24px; text-decoration: underline; text-align: center; }
        
        .top-right-info { position: absolute; right: 0.8cm; top: 0.5cm; text-align: left; width: 200px; }
        .info-row-flex { display: flex; align-items: center; gap: 5px; margin-bottom: 2px; font-size: 11px; }
        .info-label { font-weight: bold; width: 40px; flex-shrink: 0; }
        .info-content { flex-grow: 1; }

        .header-grid { margin-top: 15px; width: 45%; }
        .customer-section { display: flex; flex-direction: column; gap: 8px; }
        label { display: block; font-weight: bold; font-size: 10px; text-transform: uppercase; color: var(--dark-grey); }
        input, textarea { width: 100%; border: 1px solid #ccc; padding: 4px; border-radius: 3px; box-sizing: border-box; font-size: 11px; }
        textarea { resize: none; font-family: inherit; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; border: 1.5px solid #000; }
        th { background: var(--dark-grey); color: white; padding: 3px 1px; font-size: 8px; border: 1px solid #000; }
        td { border: 1px solid #000; padding: 0px 1px; vertical-align: middle; height: 20px; font-size: 8px; }
        
        .col-no { width: 2.5%; }
        .col-date { width: 7%; }
        .col-smu { width: 9%; } 
        .col-shipper { width: 11%; }
        .col-route { width: 5.5%; } 
        .col-comm { width: 13%; }
        .col-qty { width: 3%; }
        .col-money { width: 8.5%; }
        .col-total { width: 10%; }
        .col-action { width: 3%; }

        .tbl-input { border: none; padding: 0; text-align: center; width: 100%; font-size: 8px; background: transparent; height: 100%; }
        .txt-left { text-align: left; padding-left: 3px; }
        .txt-right { text-align: right; padding-right: 3px; }

        .footer-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 10px; margin-top: auto; padding-top: 10px; }
        .summary-table { width: 100%; border: none; }
        .summary-table td { border: none; padding: 1px 0; font-size: 11px; vertical-align: middle; height: auto !important; }
        .total-row { border-top: 2px solid var(--primary-blue); color: var(--primary-blue); font-weight: bold; font-size: 15px !important; }
        .val-cell { width: 150px; text-align: right; font-weight: bold; }

        .signature-area { text-align: center; font-size: 11px; margin-top: 20px; width: 250px; float: right; }
        .sig-space { height: 100px; } 

        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        .btn-blue { background: #0056b3; color: white; }
        .btn-orange { background: #f39c12; color: white; }
        .btn-green { background: #28a745; color: white; }

        @media print {
            @page { size: landscape; margin: 0; }
            body { background: white; padding: 0; }
            .page { box-shadow: none; margin: 0; width: 29.7cm; height: 21cm; border: none; }
            .no-print-area, .btn-add, .col-action, .btn-del { display: none !important; }
            input, textarea { border: none !important; padding: 0 !important; outline: none !important; background: transparent !important; }
        }
    </style>
</head>
<body>

<div class="no-print-area">
    <div>
        <strong>Import CSV:</strong> <input type="file" id="csvFile" accept=".csv" style="width: 170px;">
        <button class="btn btn-blue" onclick="importDatabase()">LOAD CSV</button>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-orange" onclick="downloadAsHTML()">SAVE</button>
        <button class="btn btn-green" onclick="window.print()">PRINT INVOICE</button>
    </div>
</div>

<div class="page">
    <div class="title-container">
        <h2>INVOICE</h2>
        <div class="top-right-info">
            <div class="info-row-flex">
                <span class="info-label">No</span>
                <span class="info-content">: <span id="invNoDisplay" contenteditable="true" style="color:var(--primary-blue); font-weight:bold;">001A/INV/0226</span></span>
            </div>
            <div class="info-row-flex">
                <span class="info-label">Date</span>
                <span class="info-content">: <input type="date" id="invDateInput" onchange="updateSignatureDate()" style="width:110px;"></span>
            </div>
            <div class="info-row-flex">
                <span class="info-label">Term</span>
                <span class="info-content">: <input type="text" value="7 Days" style="width:110px;"></span>
            </div>
        </div>
    </div>

    <div class="header-grid">
        <div class="customer-section">
            <div>
                <label>Customer Name</label>
                <input list="cust-list" id="custName" oninput="handleMultiAutofill(this.value)" placeholder="Pilih customer..." style="font-weight:bold; border: 1.5px solid var(--primary-blue);">
                <datalist id="cust-list"></datalist>
            </div>
            <div>
                <label>Alamat</label>
                <textarea id="custAddr" rows="3" placeholder=""></textarea>
            </div>
        </div>
    </div>

    <table id="invoiceTable">
        <thead>
            <tr>
                <th class="col-no">NO</th>
                <th class="col-date">DATE</th>
                <th class="col-smu">SMU NO</th>
                <th class="col-shipper">SHIPPER</th>
                <th class="col-route">ROUTE</th>
                <th class="col-comm">COMMODITY</th>
                <th class="col-qty">KOLI</th>
                <th class="col-qty">KG</th>
                <th class="col-qty">VOL</th>
                <th class="col-money">RATE</th>
                <th class="col-money">ADM</th>
                <th class="col-money">SC</th>
                <th class="col-money">DG</th>
                <th class="col-total">TOTAL</th>
                <th class="col-action">ACT</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    
    <button onclick="addRow()" style="margin-top:5px; font-size:10px; cursor:pointer;">+ Add row</button>

    <div class="footer-container">
        <div class="payment-box" style="font-size: 10px;">
            <div style="margin-bottom: 8px;">
                <strong>DUE DATE :</strong> 
                <input type="text" value="-" style="width: 120px; border:none; border-bottom:1px solid #ddd; font-weight:bold;">
            </div>
            <strong>Payment Transfer to:</strong><br>
            Bank MANDIRI KCP Jakarta Kota<br>
            ACC Name : <strong>Daniel Sinaga</strong><br>
            ACC IDR : <strong>1150011409887</strong>
        </div>
        <div style="text-align:right;">
            <button onclick="addAdditionalCostRow()" style="font-size:10px; cursor:pointer;">+ Additional Cost</button>
            <table class="summary-table" id="summaryTable">
                <tr><td style="text-align:right; padding-right:10px;">Sub Total</td><td id="subTotal" class="val-cell">Rp 0</td></tr>
                <tr class="total-row"><td style="text-align:right; padding-right:10px;">TOTAL INVOICE</td><td id="grandTotal" class="val-cell">Rp 0</td></tr>
            </table>
            <div class="signature-area">
                <span id="signatureDate">Jakarta, ...</span>
                <div class="sig-space"></div>
                <div style="font-weight:bold; text-decoration:underline;">( Luki Nur Ain )</div>
            </div>
        </div>
    </div>
</div>

<script>
    let globalDatabase = []; 
    let invoiceCounter = 1;
    let lastCustomer = "";

    function formatIDR(val) {
        let num = Math.round(val).toString().replace(/[^0-9]/g, '');
        if (!num || num === "0") return "Rp 0";
        return "Rp " + parseInt(num).toLocaleString('id-ID');
    }

    function parseNum(val) {
        if (!val) return 0;
        let clean = val.toString().replace(/Rp/g, '').replace(/\./g, '').trim();
        return parseFloat(clean) || 0;
    }

    function calculate() {
        let sub = 0;
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const kg = parseFloat(row.querySelector('.kg').value) || 0;
            const vol = parseFloat(row.querySelector('.vol').value) || 0;
            const r = parseNum(row.querySelector('.rate').value);
            const a = parseNum(row.querySelector('.adm').value);
            const d = parseNum(row.querySelector('.dg').value);
            const commText = row.querySelector('.comm-input').value;
            let surEl = row.querySelector('.sur');

            const foundPercent = commText.match(/\d+/); 
            if (commText.toLowerCase().includes('heavy') && foundPercent) {
                const percentValue = parseFloat(foundPercent[0]);
                let autoSur = (r * kg) * (percentValue / 100);
                surEl.value = formatIDR(autoSur);
            }

            const s = parseNum(surEl.value);
            const total = (vol * r) + a + s + d;
            row.querySelector('.row-total').innerText = formatIDR(total);
            sub += total;
        });
        
        let addTotal = 0;
        document.querySelectorAll('.add-cost-input').forEach(input => { addTotal += parseNum(input.value); });
        document.getElementById('subTotal').innerText = formatIDR(sub);
        document.getElementById('grandTotal').innerText = formatIDR(sub + addTotal);
    }

    function downloadAsHTML() {
        let currentHTML = document.documentElement.outerHTML;
        const blob = new Blob([currentHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Invoice_Backup_${new Date().getTime()}.html`;
        a.click();
    }

    function handleMultiAutofill(selectedCust) {
        if (selectedCust && selectedCust !== lastCustomer) {
            const date = new Date();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            document.getElementById('invNoDisplay').innerText = `${invoiceCounter.toString().padStart(3, '0')}A/INV/${month}${year}`;
            invoiceCounter++;
            lastCustomer = selectedCust;
        }

        const matches = globalDatabase.filter(d => d.customer === selectedCust);
        if (matches.length > 0) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            matches.forEach((data, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="text-align:center;">${index + 1}</td>
                    <td><input type="text" class="tbl-input" value="${data.date}"></td>
                    <td><input type="text" class="tbl-input" value="${data.smu}"></td>
                    <td><input type="text" class="tbl-input" value="${data.shipper}"></td>
                    <td><input type="text" class="tbl-input" value="${data.route}"></td>
                    <td><input type="text" class="tbl-input txt-left comm-input" value="${data.commodity}" oninput="calculate()"></td>
                    <td><input type="number" class="tbl-input" value="${data.koli}"></td>
                    <td><input type="number" class="tbl-input kg" value="${data.kg}" oninput="calculate()"></td>
                    <td><input type="number" class="tbl-input vol" value="${data.vol}" oninput="calculate()"></td>
                    <td><input type="text" class="tbl-input rate txt-right" value="${formatIDR(data.rate)}" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
                    <td><input type="text" class="tbl-input adm txt-right" value="${formatIDR(data.adm)}" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
                    <td><input type="text" class="tbl-input sur txt-right" value="${formatIDR(data.sur)}" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
                    <td><input type="text" class="tbl-input dg txt-right" value="${formatIDR(data.dg)}" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
                    <td class="row-total txt-right" style="font-weight:bold;">Rp 0</td>
                    <td class="col-action" style="text-align:center;"><button onclick="this.closest('tr').remove();calculate();">X</button></td>
                `;
            });
            calculate();
        }
    }

    function addRow() {
        const tbody = document.getElementById('tableBody');
        const row = tbody.insertRow();
        row.innerHTML = `
            <td style="text-align:center;">${tbody.rows.length}</td>
            <td><input type="text" class="tbl-input"></td>
            <td><input type="text" class="tbl-input"></td>
            <td><input type="text" class="tbl-input"></td>
            <td><input type="text" class="tbl-input"></td>
            <td><input type="text" class="tbl-input txt-left comm-input" oninput="calculate()"></td>
            <td><input type="number" class="tbl-input" value="1"></td>
            <td><input type="number" class="tbl-input kg" oninput="calculate()"></td>
            <td><input type="number" class="tbl-input vol" oninput="calculate()"></td>
            <td><input type="text" class="tbl-input rate txt-right" value="Rp 0" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
            <td><input type="text" class="tbl-input adm txt-right" value="Rp 0" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
            <td><input type="text" class="tbl-input sur txt-right" value="Rp 0" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
            <td><input type="text" class="tbl-input dg txt-right" value="Rp 0" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
            <td class="row-total txt-right" style="font-weight:bold;">Rp 0</td>
            <td class="col-action" style="text-align:center;"><button onclick="this.closest('tr').remove();calculate();">X</button></td>
        `;
    }

    function addAdditionalCostRow() {
        const table = document.getElementById('summaryTable');
        const row = table.insertRow(table.rows.length - 1);
        row.innerHTML = `
            <td style="text-align:right; padding-right:10px;"><input type="text" value="Keterangan" style="text-align:right; border:none; width:100%; font-size:11px;"></td>
            <td class="val-cell"><input type="text" class="add-cost-input" value="Rp 0" style="text-align:right; border:none; width:100%; font-weight:bold;" oninput="this.value=formatIDR(parseNum(this.value));calculate()"></td>
        `;
    }

    function importDatabase() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Pilih file CSV!");
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split('\n');
            globalDatabase = [];
            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(';');
                if (cols.length >= 10) {
                    globalDatabase.push({
                        date: cols[0]?.trim(), smu: cols[1]?.trim(), customer: cols[2]?.replace(/\"/g, '').trim(),
                        shipper: cols[3]?.trim(), route: cols[4]?.trim(), commodity: cols[5]?.trim(),
                        koli: cols[6]?.trim(), kg: cols[7]?.trim(), vol: cols[8]?.trim(),
                        rate: cols[9]?.replace(/[^0-9]/g, '') || "0", adm: cols[10]?.replace(/[^0-9]/g, '') || "0",
                        sur: cols[11]?.replace(/[^0-9]/g, '') || "0", dg: cols[12]?.replace(/[^0-9]/g, '') || "0"
                    });
                }
            }
            const dl = document.getElementById('cust-list'); dl.innerHTML = "";
            [...new Set(globalDatabase.map(d => d.customer))].forEach(n => { if(n){ let o=document.createElement('option'); o.value=n; dl.appendChild(o); }});
            alert("Database Dimuat!");
        };
        reader.readAsText(file);
    }

    function updateSignatureDate() {
        const d = document.getElementById('invDateInput').value;
        if (d) document.getElementById('signatureDate').innerText = `Jakarta, ${new Date(d).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'})}`;
    }

    window.onload = () => {
        document.getElementById('invDateInput').value = new Date().toISOString().split('T')[0];
        updateSignatureDate();
        addRow();
    }
</script>
</body>
</html>
